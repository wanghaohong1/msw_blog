# 微服务架构与运维实践

随着业务复杂度提升，微服务能够带来灵活的扩展与迭代速度，但也带来部署、治理、观测的挑战。本笔记总结从服务拆分、基础设施到运维体系的关键知识点。

## 架构设计原则

- **按业务能力拆分**：以业务领域与团队边界为准，避免技术维度拆分导致依赖混乱。
- **服务自治**：每个服务独立数据库、配置、部署流程，保持高内聚低耦合。
- **接口契约化**：定义清晰的 API、事件消息契约，维持兼容性与可演进性。
- **容错与降级**：预设失败场景，设计限流、熔断、降级策略，确保核心功能可用。

## 核心组件

- **服务网关**
  - 提供统一入口、鉴权、流控、日志审计。
  - 常见实现：Spring Cloud Gateway、Kong、APISIX、Nginx + Lua。
- **服务注册/发现**
  - 管理服务实例生命周期，搭配健康检查与权重路由。
  - 选型：Nacos、Eureka、Consul、Zookeeper。
- **配置中心**
  - 集中管理环境配置、敏感信息，支持灰度配置。
  - 选型：Nacos Config、Apollo、Spring Cloud Config。
- **服务通信**
  - HTTP/REST：通用易用，适合对外接口。
  - gRPC/Dubbo：高性能二进制协议，适合内部调用。
  - 事件驱动：基于 Kafka、RocketMQ，解耦业务并支持回溯。

## 交付与运维流水线

1. **CI/CD 流程**
   - 代码提交触发单元、集成测试。
   - 构建 Docker 镜像并扫描漏洞（Trivy、Clair）。
   - 使用 Jenkins、GitLab CI、Argo CD 完成部署审批与执行。
2. **容器与编排**
   - Dockerfile 定义镜像，关注镜像层次、运行用户、安全加固。
   - Kubernetes 管理服务，配置 Deployment、Service、Ingress、HPA。
   - 配置 ConfigMap、Secret、StatefulSet 满足有状态服务需求。
3. **环境治理**
   - 区分开发、测试、预发、生产环境，配置隔离的资源与网络。
   - 灰度发布：基于流量权重、标签、蓝绿部署等策略。

## 可观测性体系

- **监控**：Prometheus + Grafana 建立指标采集与告警，关注 QPS、延迟、错误率、资源利用率。
- **日志**：使用 ELK/EFK 或 Loki + Promtail，实现集中化检索与追踪。
- **链路追踪**：SkyWalking、Jaeger 提供分布式追踪，定位跨服务瓶颈。
- **告警策略**：设置多级告警（延迟、错误、指标阈值、资源），支持值班轮值与告警收敛。

## 安全与合规

- 鉴权与认证：统一身份认证（SSO）、OAuth2.0、JWT。
- 传输安全：全站 HTTPS、服务间 mTLS、证书自动化管理（Let's Encrypt）。
- 数据安全：敏感信息加密，审计日志留存，满足合规要求（如等保、GDPR）。
- 权限管理：RBAC + ABAC 结合，明确资源访问界限。

## 常见挑战与应对

- **服务膨胀**：定期回顾服务拆分边界，合并过度细粒度服务。
- **调用链复杂**：建立拓扑图，自动化生成依赖矩阵。
- **资源成本上升**：使用弹性伸缩与非高峰缩容策略。
- **跨团队协作**：实施 DevOps 文化，建立统一文档与接口评审流程。

## 自查清单

- 是否具备自动化部署与回滚方案？回滚耗时是否可控？
- 是否建立统一可观测性平台并覆盖核心指标？
- 是否对关键服务设置熔断、限流、重试及降级策略？
- 是否评估过服务拆分后的数据一致性方案与事务边界？

## 推荐资料

- 《微服务设计》《Kubernetes 权威指南》
- CNCF Landscape 与 Cloud Native TrailMap
- Google SRE Handbook、阿里巴巴中台实践文章
- 开源项目：`istio/istio`、`apache/dubbo`、`apache/rocketmq`

