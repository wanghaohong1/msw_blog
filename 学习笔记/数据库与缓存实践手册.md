# 数据库与缓存实践手册

数据层决定了系统的稳定性和性能上限。这里汇总关系型数据库、缓存与 NoSQL 的核心知识点以及常见实战技巧，帮助在设计与运维阶段规避风险。

## 关系型数据库（以 MySQL 为例）

- **表结构设计**
  - 根据业务访问模式选择范式或反范式设计，避免过度 join。
  - 关键字段使用合适的数据类型（`BIGINT UNSIGNED` 比 `VARCHAR` 更高效）。
  - 使用 `comment` 文档化字段含义。
- **索引策略**
  - 主键索引用于唯一标识，选择有序、稳定的字段（推荐雪花 ID 或自增 ID）。
  - 覆盖索引、联合索引需考虑最左前缀原则，避免过度创建。
  - 定期使用 `EXPLAIN` 分析执行计划，关注 `type`、`extra` 字段。
- **事务与锁**
  - 理解隔离级别（RR、RC、SERIALIZABLE）与 MVCC 原理。
  - 常见锁：行锁、间隙锁、临键锁；通过加索引减少锁粒度。
  - 使用 `select ... for update` 时注意索引命中，避免全表锁。
- **性能优化**
  - 合理配置连接池参数（maxActive、maxIdle、maxWait）。
  - 对慢查询收集统计信息，将高频写操作拆分异步或批处理。
  - 使用分库分表或读写分离时，确保 ID 唯一性与全局事务策略。

## 缓存体系（Redis 为例）

- **数据结构与场景**
  - `String` 存储简单 KV，`Hash` 适合对象，`SortedSet` 用于排行榜。
  - 利用 HyperLogLog、Bitmap 进行统计类需求。
- **缓存策略**
  - 缓存穿透：设置空值缓存或使用布隆过滤器。
  - 缓存击穿：对热点 key 加互斥锁或使用逻辑过期策略。
  - 缓存雪崩：设置随机过期时间、分散刷新时间点。
- **持久化与高可用**
  - RDB 快照与 AOF 结合，权衡性能与数据安全。
  - 主从复制 + Sentinel 或 Redis Cluster 实现故障自动切换。
  - 评估内存占用，避免 big key 阻塞主线程。

## NoSQL 与搜索引擎

- **MongoDB**
  - 适合文档型、灵活 schema 场景，选用合适的 `shard key`。
  - 熟悉副本集、分片集群的部署与备份策略。
- **ElasticSearch**
  - 用于全文检索与复杂查询，理解倒排索引、分片与副本机制。
  - 编写合理的 mapping，避免字段类型频繁变更。
  - 配合 Logstash/Filebeat 实现日志集中分析。

## 数据治理与安全

- 数据权限：按照最小权限原则管理账号，生产环境禁止直连。
- 定期备份与演练恢复流程，备份和恢复都要经过压测验证。
- 敏感信息脱敏存储，使用 AES、SM4 等算法加密。
- 建立数据审计日志，记录 DDL/DML 操作来源与影响范围。

## 常见组合策略

- **读多写少业务**：数据库 + 多级缓存（本地 Caffeine + Redis）。
- **高并发写入**：消息队列削峰，异步写库，结合批量提交。
- **全局搜索**：MySQL 作为主存，ElasticSearch 提供检索，定期校验一致性。
- **分析报表**：OLTP 与 OLAP 分离，实时同步到 ClickHouse、Doris 等列式存储。

## 自查清单

- 新建表是否包含主键、创建时间、更新时间、唯一键约束？
- SQL 是否经过 `EXPLAIN` 与慢查询分析？索引利用率是否达标？
- 缓存是否具备监控告警、命中率统计与过期策略？
- 宕机恢复流程是否经过演练，恢复时间与数据损失可接受吗？

## 推荐资料

- 《高性能 MySQL（第 4 版）》《Redis 设计与实现》
- 极客时间《MySQL 45 讲》《从零开始学架构》
- Redis 官方文档与 `redis.io/commands`
- Elastic 官方博客与实践案例（Logging、APM、Security）

